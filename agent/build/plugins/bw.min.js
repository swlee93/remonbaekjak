!function(){var o,B;BOOMR=window.BOOMR||{};BOOMR.plugins=BOOMR.plugins||{};if(!BOOMR.plugins.BW){(B=[{name:"image-0.png",size:11773,timeout:1400},{name:"image-1.png",size:40836,timeout:1200},{name:"image-2.png",size:165544,timeout:1300},{name:"image-3.png",size:382946,timeout:1500},{name:"image-4.png",size:1236278,timeout:1200},{name:"image-5.png",size:4511798,timeout:1200},{name:"image-6.png",size:9092136,timeout:1200}]).end=B.length;B.start=0;B.l={name:"image-l.gif",size:35,timeout:1e3};o={base_url:"",timeout:15e3,nruns:5,latency_runs:10,user_ip:"",block_beacon:!1,test_https:!1,cookie_exp:604800,cookie:"BA",results:[],latencies:[],latency:null,runs_left:0,aborted:!1,complete:!0,running:!1,initialized:!1,ncmp:function(t,e){return t-e},iqr:function(t){var e,i=t.length-1,n=[],s=(t[Math.floor(.25*i)]+t[Math.ceil(.25*i)])/2,r=(t[Math.floor(.75*i)]+t[Math.ceil(.75*i)])/2,a=1.5*(r-s);if(0==a)return t;i++;for(e=0;e<i&&t[e]<r+a;e++)t[e]>s-a&&n.push(t[e]);return n},calc_latency:function(){var t,e,i,n,s,r,a=0,l=0;this.latencies.shift();e=(r=this.iqr(this.latencies.sort(this.ncmp))).length;BOOMR.debug("latencies: "+this.latencies,"bw");BOOMR.debug("lat_filtered: "+r,"bw");for(t=0;t<e;t++){a+=r[t];l+=r[t]*r[t]}i=Math.round(a/e);s=(1.96*(n=Math.sqrt(l/e-a*a/(e*e)))/Math.sqrt(e)).toFixed(2);n=n.toFixed(2);return{mean:i,median:Math.round((r[Math.floor(e/2)]+r[Math.ceil(e/2)])/2),stddev:n,stderr:s}},calc_bw:function(){for(var t,e,i,n,s,r,a,l,o,u,h,c,d=0,m=[],O=[],b=0,g=0,_=0,M=0,f=[],p=0;p<this.nruns;p++)if(this.results[p]&&this.results[p].r){h=0;for(t=(e=this.results[p].r).length-1;0<=t&&h<3&&e[t];t--)if(null!==e[t].t){d++;h++;c=1e3*B[t].size/e[t].t;m.push(c);if(e[t].t>this.latency.mean){c=1e3*B[t].size/(e[t].t-this.latency.mean);O.push(c)}else f.push(t+"_"+e[t].t)}}BOOMR.debug("got "+d+" readings","bw");BOOMR.debug("bandwidths: "+m,"bw");BOOMR.debug("corrected: "+O,"bw");if(3<m.length){m=this.iqr(m.sort(this.ncmp));O=this.iqr(O.sort(this.ncmp))}else{m=m.sort(this.ncmp);O=O.sort(this.ncmp)}BOOMR.debug("after iqr: "+m,"bw");BOOMR.debug("corrected: "+O,"bw");d=Math.max(m.length,O.length);for(p=0;p<d;p++){if(p<m.length){b+=m[p];g+=Math.pow(m[p],2)}if(p<O.length){_+=O[p];M+=Math.pow(O[p],2)}}d=m.length;i=Math.round(b/d);n=Math.sqrt(g/d-Math.pow(b/d,2));s=Math.round(1.96*n/Math.sqrt(d));n=Math.round(n);d=m.length-1;r=Math.round((m[Math.floor(d/2)]+m[Math.ceil(d/2)])/2);if(O.length<1){BOOMR.debug("not enough valid corrected datapoints, falling back to uncorrected","bw");f.push("l=="+O.length);a=i;l=n;o=s;u=r}else{d=O.length;a=Math.round(_/d);o=(1.96*(l=Math.sqrt(M/d-Math.pow(_/d,2)))/Math.sqrt(d)).toFixed(2);l=l.toFixed(2);d=O.length-1;u=Math.round((O[Math.floor(d/2)]+O[Math.ceil(d/2)])/2)}BOOMR.debug("amean: "+i+", median: "+r,"bw");BOOMR.debug("corrected amean: "+a+", median: "+u,"bw");return{mean:i,stddev:n,stderr:s,median:r,mean_corrected:a,stddev_corrected:l,stderr_corrected:o,median_corrected:u,debug_info:f}},load_img:function(e,i,n){var t=this.base_url+B[e].name+"?t="+BOOMR.utils.generateId(10),s=0,r=0,a=new Image,l=this;function o(t){return function(){n&&n.call(l,e,r,i,t);if(null!==t){a.onload=a.onerror=null;a=null;clearTimeout(s);l=n=null}}}a.onload=o(!0);a.onerror=o(!1);s=setTimeout(o(null),B[e].timeout+Math.min(400,this.latency?this.latency.mean:400));r=BOOMR.now();a.src=t},lat_loaded:function(t,e,i,n){if(i===this.latency_runs+1){if(null!==n){e=BOOMR.now()-e;this.latencies.push(e)}0===this.latency_runs&&(this.latency=this.calc_latency());BOOMR.setImmediate(this.iterate,null,null,this)}},img_loaded:function(t,e,i,n){if(i===this.runs_left+1&&!this.results[this.nruns-i].r[t])if(null!==n){e={start:e,end:BOOMR.now(),t:null,state:n,run:i};n&&(e.t=e.end-e.start);this.results[this.nruns-i].r[t]=e;if(t>=B.end-1||void 0!==this.results[this.nruns-i].r[t+1]){BOOMR.debug(BOOMR.utils.objectToString(this.results[this.nruns-i],void 0,2),"bw");i===this.nruns&&(B.start=t);BOOMR.setImmediate(this.iterate,null,null,this)}else this.load_img(t+1,i,this.img_loaded)}else this.results[this.nruns-i].r[t+1]={t:null,state:null,run:i}},finish:function(){this.latency||(this.latency=this.calc_latency());var t=this.calc_bw(),e={bw:t.median_corrected,bw_err:parseFloat(t.stderr_corrected,10),lat:this.latency.mean,lat_err:parseFloat(this.latency.stderr,10),bw_time:Math.round(BOOMR.now()/1e3)};BOOMR.addVar(e);0<t.debug_info.length&&BOOMR.addVar("bw_debug",t.debug_info.join(","));!isNaN(e.bw)&&0<e.bw&&BOOMR.utils.setCookie(this.cookie,{ba:Math.round(e.bw),be:e.bw_err,l:e.lat,le:e.lat_err,ip:this.user_ip,t:e.bw_time},this.user_ip?this.cookie_exp:0);(this.complete=!0)===this.block_beacon&&BOOMR.sendBeacon();this.running=!1},iterate:function(){if(!this.aborted)if(this.runs_left)if(this.latency_runs)this.load_img("l",this.latency_runs--,this.lat_loaded);else{this.results.push({r:[]});this.load_img(B.start,this.runs_left--,this.img_loaded)}else this.finish()},setVarsFromCookie:function(){var t,e,i,n,s,r,a,l=BOOMR.utils.getSubCookies(BOOMR.utils.getCookie(o.cookie));if(l&&l.ba){t=parseInt(l.ba,10);e=parseFloat(l.be,10);i=parseInt(l.l,10)||0;n=parseFloat(l.le,10)||0;s=l.ip.replace(/\.\d+$/,"0");r=parseInt(l.t,10);a=this.user_ip.replace(/\.\d+$/,"0");l=Math.round(BOOMR.now()/1e3);if(s===a&&r>=l-this.cookie_exp&&0<t){this.complete=!0;BOOMR.addVar({bw:t,lat:i,bw_err:e,lat_err:n,bw_time:r});return!0}}return!1}};BOOMR.plugins.BW={init:function(t){if(o.initialized)return this;BOOMR.utils.pluginConfig(o,t,"BW",["base_url","timeout","nruns","cookie","cookie_exp","test_https","block_beacon"]);t&&t.user_ip&&(o.user_ip=t.user_ip);if(!o.base_url)return this;B.start=0;o.runs_left=o.nruns;o.latency_runs=10;o.results=[];o.latencies=[];o.latency=null;o.complete=o.aborted=!1;BOOMR.removeVar("ba","ba_err","lat","lat_err");o.setVarsFromCookie()||BOOMR.subscribe("page_ready",this.run,null,this);o.initialized=!0;return this},run:function(){var t;if(o.running||o.complete)return this;(t=BOOMR.window.document.createElement("a")).href=o.base_url;if(!o.test_https&&"https:"===t.protocol){BOOMR.info("HTTPS detected, skipping bandwidth test","bw");(o.complete=!0)===o.block_beacon&&BOOMR.sendBeacon();return this}o.base_url=t.href;o.running=!0;setTimeout(this.abort,o.timeout);o.iterate();return this},abort:function(){o.aborted=!0;o.running&&o.finish()},is_complete:function(){return!0!==o.block_beacon||o.complete}}}}();
//# sourceMappingURL=bw.min.js.map